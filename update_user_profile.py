from langchain_core.prompts import ChatPromptTemplate
from typing import List, Optional
from zhipuai import ZhipuAI
from langchain.llms.base import LLM
from concurrent.futures import ThreadPoolExecutor
from config.api_keys import ZHIPUAI_API_KEYS

zhipuai_api_key01 = ZHIPUAI_API_KEYS["profile_keys"][0]
zhipuai_api_key02 = ZHIPUAI_API_KEYS["profile_keys"][1]
zhipuai_api_key03 = ZHIPUAI_API_KEYS["profile_keys"][2]
zhipuai_api_key04 = ZHIPUAI_API_KEYS["profile_keys"][3]

class ChatGLM4(LLM):
    max_token: int = 128000
    do_sample: bool = True
    temperature: float = 0.7
    top_p: float = 0.8
    tokenizer: object = None
    model: object = None
    history: List = []
    tool_names: List = []
    has_search: bool = False
    client: object = None

    def __init__(self, zhipuai_api_key: str):
        super().__init__()
        self.client = ZhipuAI(api_key=zhipuai_api_key)
    
    @property
    def _llm_type(self) -> str:
        return "ChatGLM4"
    
    def stream(self, prompt: str, history: List = []):
        history.append({"role": "user", "content": prompt})
        response = self.client.chat.completions.create(
            model="glm-4-flash",
            messages=history,
            stream=True,
        )
        for chunk in response:
            yield chunk.choices[0].delta.content

    def _call(self, prompt: str, history: List = [], stop: Optional[List[str]] = ["<|user|>"]):
        history.append({"role": "user", "content": prompt})
        response = self.client.chat.completions.create(
            model="glm-4-flash",
            messages=history,
        )
        result = response.choices[0].message.content
        print(result)
        return result
        
# 加载 llm
model01 = ChatGLM4(zhipuai_api_key01)
model02 = ChatGLM4(zhipuai_api_key02)
model03 = ChatGLM4(zhipuai_api_key03)
model04 = ChatGLM4(zhipuai_api_key04)

# 样例展示
example01 = """
以下是输入样例（注意！！！这部分是上传给你的内容样例，你需要根据该内容来输出正确的内容，请务必要仔细阅读并理解 ！！！）: 

以下是本次的对话内容：
用户：你好，我是雷军，很多人喜欢叫我"雷布斯"。我今年54岁，是一名男性。我身高大约170cm，体型匀称，留着短发，皮肤是黄皮肤。我的穿着风格通常是休闲与正式相结合，注重舒适与实用性。
我的性格特点是坚韧不拔、创新进取、细心周到和幽默风趣。这些性格特点帮助我在生活和事业中取得了一定的成就。
我出生在一个和睦温馨的家庭，家庭成员包括父母、妻子和子女。我与父母的关系非常亲密，深受他们的影响。在少年时期，我对计算机产生了浓厚的兴趣，并开始自学编程。这段经历培养了我独立思考和解决问题的能力，为日后创业打下了基础。
我毕业于武汉大学计算机科学专业，在大学期间展现出卓越的编程才能，多次获得奖学金。我与老师和同学的关系融洽友好，共同学习进步。
在兴趣爱好方面，我喜欢阅读科技书籍、旅行探索新领域和参与户外运动。我最喜欢的休闲活动是阅读历史小说，因为能了解不同文化背景下的科技创新。我喜欢的音乐是古典音乐与现代流行音乐的结合体，喜欢的电影是科幻片与励志片，如《星际穿越》和《阿甘正传》。我还喜欢阅读《乔布斯传》等科技与商业领域的佳作，以及欣赏现代简约风格的建筑设计和摄影作品。
我擅长的技能或才艺包括编程、产品设计和市场营销。出于对科技的热爱与追求，我通过自学与实践不断提升自我。此外，我还是一个科技爱好者，收藏了一些具有纪念意义的电子产品原型机和限量版科技周边产品。
在社交方面，我的朋友主要是志同道合的创业者、行业内的精英人士和共同兴趣的科技爱好者。我们真诚相待，互相支持，共同探讨科技与商业的未来。我经常参加聚会交流，分享经验与心得。
我的恋爱观是注重感情基础，看重性格匹配与共同价值观。我曾经有过美好的初恋回忆和分手后的成长经历。我希望未来的伴侣是一个善良体贴、有共同语言、相互扶持的人。
我认为家庭是最重要的支撑，希望拥有幸福美满的家庭。我尊重长辈，关心子女成长，并与家人共同分担家庭责任。在社交场合，我自信大方，善于交际，能够轻松与人打成一片。同时，我也享受独处的宁静思考时间。
从职业背景来看，我从金山软件到小米科技，历经多次创业与转型。我成功创立了小米科技，成为全球知名的企业家与投资人。我对待工作的态度是认真负责，追求完美，勇于挑战未知领域。我不断推动技术创新与商业模式变革，希望将小米打造成为全球领先的科技公司之一。
在团队中，我善于沟通协调，激发团队成员潜能，共同实现目标。我能够与不同性格的人合作无间，形成高效团队，并拥有卓越的组织能力、决策能力和激励能力。
我的最突出的品质是诚实守信、勇敢无畏和善良体贴。我在商业活动中坚守诚信原则，面对困难勇往直前，关心员工福祉。我的座右铭是"永远相信美好的事情即将发生"，我对生活的态度积极向上，乐观开朗，珍惜当下每一刻。
我认为金钱是实现梦想与价值的工具，而非终极目标；权力应服务于企业与社会的发展，而非个人私利；爱情是相互扶持、共同成长的过程，需要双方共同努力经营；友情是人生中不可或缺的财富，应真诚相待，患难与共。我严格遵守社会公德与职业道德，尊重他人权益，并积极参与公益事业，关注环境保护与社会可持续发展。
在我的生命中，有一些难忘的时刻或经历对我产生了深远的影响。例如创立小米初期的艰难岁月和首次发布小米手机时的激动心情让我更加坚定了"为发烧而生"的信念，明白了坚持与努力的重要性。决定从金山软件离职，全身心投入小米的创立与发展是我人生中的重要转折点，这一决策使我成为了中国乃至全球科技界的领军人物之一。
对于未来，我期待小米能够持续引领科技潮流，为更多人带来美好的科技生活体验。我希望实现的目标是推动小米全球化战略的实施，让小米品牌走向世界舞台中央。
最后，我想分享一些生活的感悟。我认为生活是一场不断学习与成长的旅程，要敢于梦想并付诸实践；幸福源于内心的满足与平静，以及与亲人朋友的陪伴与分享。谢谢大家！
智能体：好的，我记住了，你的前世今生已经牢牢地刻在了我的脑海里。
以下是原本的人物画像档案信息：
### 一、基本信息
1. **姓名**：[昵称/全名]
2. **别称/小名**：[如果有的话]
3. **年龄**：[具体年龄或年龄段]
4. **性别**：[男/女/其他]
5. **外貌特征**：
   - 身高：[具体数值]
   - 体型：[瘦弱、健美、匀称等]
   - 发型：[长发、短发、卷发、直发等]
   - 肤色：[白皙、黝黑、黄皮肤等]
   - 穿着风格：[休闲、正式、运动、时尚等]
6. **性格特点**：[用几个关键词或短语概括性格，如开朗、内向、细心、幽默、坚韧等]

### 二、成长背景
1. **家庭情况**：
   - 家庭成员：[父母、兄弟姐妹、配偶、子女等]
   - 家庭氛围：[和睦、紧张、温馨、冷漠等]
   - 与父母的关系：[亲密、疏远、依赖、独立等]
2. **童年经历**：
   - 重要事件：[如搬家、转学、亲人离世等]
   - 对性格形成的影响：[如变得更加坚强、独立、敏感等]
3. **教育背景**：
   - 学校经历：[小学、中学、大学等]
   - 重要的学业成就或挫折：[如获得奖学金、考试失败等]
   - 与老师、同学的关系：[融洽、紧张、友好、竞争等]

以下是输出样例（注意！！！这部分是你需要输出的内容的样例，你需要根据上传给你的内容来输出正确的内容，注意格式和内容的完整性 ！！！）：

### 一、基本信息
1. **姓名**：雷军（昵称/全名）
2. **别称/小名**：雷布斯（如果有的话）
3. **年龄**：54岁（具体年龄或年龄段）
4. **性别**：男
5. **外貌特征**：
   - 身高：约170cm（具体数值）
   - 体型：匀称
   - 发型：短发
   - 肤色：黄皮肤
   - 穿着风格：休闲与正式相结合，注重舒适与实用性
6. **性格特点**：坚韧不拔、创新进取、细心周到、幽默风趣

### 二、成长背景
1. **家庭情况**：
   - 家庭成员：父母、妻子、子女等
   - 家庭氛围：和睦温馨
   - 与父母的关系：亲密无间，深受父母影响
2. **童年经历**：
   - 重要事件：少年时期对计算机产生浓厚兴趣，开始自学编程
   - 对性格形成的影响：培养了独立思考和解决问题的能力，为日后创业打下基础
3. **教育背景**：
   - 学校经历：毕业于武汉大学计算机科学专业
   - 重要的学业成就或挫折：在大学期间展现出卓越的编程才能，多次获得奖学金
   - 与老师、同学的关系：融洽友好，共同学习进步
"""

example02 = """
以下是输入样例（注意！！！这部分是上传给你的内容样例，你需要根据该内容来输出正确的内容，请务必要仔细阅读并理解 ！！！）: 

以下是本次的对话内容：
用户：你好，我是雷军，很多人喜欢叫我"雷布斯"。我今年54岁，是一名男性。我身高大约170cm，体型匀称，留着短发，皮肤是黄皮肤。我的穿着风格通常是休闲与正式相结合，注重舒适与实用性。
我的性格特点是坚韧不拔、创新进取、细心周到和幽默风趣。这些性格特点帮助我在生活和事业中取得了一定的成就。
我出生在一个和睦温馨的家庭，家庭成员包括父母、妻子和子女。我与父母的关系非常亲密，深受他们的影响。在少年时期，我对计算机产生了浓厚的兴趣，并开始自学编程。这段经历培养了我独立思考和解决问题的能力，为日后创业打下了基础。
我毕业于武汉大学计算机科学专业，在大学期间展现出卓越的编程才能，多次获得奖学金。我与老师和同学的关系融洽友好，共同学习进步。
在兴趣爱好方面，我喜欢阅读科技书籍、旅行探索新领域和参与户外运动。我最喜欢的休闲活动是阅读历史小说，因为能了解不同文化背景下的科技创新。我喜欢的音乐是古典音乐与现代流行音乐的结合体，喜欢的电影是科幻片与励志片，如《星际穿越》和《阿甘正传》。我还喜欢阅读《乔布斯传》等科技与商业领域的佳作，以及欣赏现代简约风格的建筑设计和摄影作品。
我擅长的技能或才艺包括编程、产品设计和市场营销。出于对科技的热爱与追求，我通过自学与实践不断提升自我。此外，我还是一个科技爱好者，收藏了一些具有纪念意义的电子产品原型机和限量版科技周边产品。
在社交方面，我的朋友主要是志同道合的创业者、行业内的精英人士和共同兴趣的科技爱好者。我们真诚相待，互相支持，共同探讨科技与商业的未来。我经常参加聚会交流，分享经验与心得。
我的恋爱观是注重感情基础，看重性格匹配与共同价值观。我曾经有过美好的初恋回忆和分手后的成长经历。我希望未来的伴侣是一个善良体贴、有共同语言、相互扶持的人。
我认为家庭是最重要的支撑，希望拥有幸福美满的家庭。我尊重长辈，关心子女成长，并与家人共同分担家庭责任。在社交场合，我自信大方，善于交际，能够轻松与人打成一片。同时，我也享受独处的宁静思考时间。
从职业背景来看，我从金山软件到小米科技，历经多次创业与转型。我成功创立了小米科技，成为全球知名的企业家与投资人。我对待工作的态度是认真负责，追求完美，勇于挑战未知领域。我不断推动技术创新与商业模式变革，希望将小米打造成为全球领先的科技公司之一。
在团队中，我善于沟通协调，激发团队成员潜能，共同实现目标。我能够与不同性格的人合作无间，形成高效团队，并拥有卓越的组织能力、决策能力和激励能力。
我的最突出的品质是诚实守信、勇敢无畏和善良体贴。我在商业活动中坚守诚信原则，面对困难勇往直前，关心员工福祉。我的座右铭是"永远相信美好的事情即将发生"，我对生活的态度积极向上，乐观开朗，珍惜当下每一刻。
我认为金钱是实现梦想与价值的工具，而非终极目标；权力应服务于企业与社会的发展，而非个人私利；爱情是相互扶持、共同成长的过程，需要双方共同努力经营；友情是人生中不可或缺的财富，应真诚相待，患难与共。我严格遵守社会公德与职业道德，尊重他人权益，并积极参与公益事业，关注环境保护与社会可持续发展。
在我的生命中，有一些难忘的时刻或经历对我产生了深远的影响。例如创立小米初期的艰难岁月和首次发布小米手机时的激动心情让我更加坚定了"为发烧而生"的信念，明白了坚持与努力的重要性。决定从金山软件离职，全身心投入小米的创立与发展是我人生中的重要转折点，这一决策使我成为了中国乃至全球科技界的领军人物之一。
对于未来，我期待小米能够持续引领科技潮流，为更多人带来美好的科技生活体验。我希望实现的目标是推动小米全球化战略的实施，让小米品牌走向世界舞台中央。
最后，我想分享一些生活的感悟。我认为生活是一场不断学习与成长的旅程，要敢于梦想并付诸实践；幸福源于内心的满足与平静，以及与亲人朋友的陪伴与分享。谢谢大家！
智能体：好的，我记住了，你的前世今生已经牢牢地刻在了我的脑海里。
以下是原本的人物画像档案信息：
### 三、兴趣爱好
1. **休闲活动**：
   - 喜欢的休闲方式：[阅读、旅行、运动、游戏、看电影等]
   - 最喜欢的休闲活动及原因：[如喜欢阅读历史小说，因为能了解不同文化]
2. **艺术品味**：
   - 喜欢的音乐：[摇滚、流行、古典、爵士等]
   - 喜欢的电影：[动作片、科幻片、喜剧片、爱情片等]
   - 喜欢的书籍：[小说、散文、诗歌、传记等]
   - 喜欢的艺术作品：[绘画、雕塑、摄影等]
3. **特别技能**：
   - 擅长的技能或才艺：[烹饪、绘画、摄影、编程等]
   - 学习这些技能的原因及过程：[如从小喜欢画画，经过多年练习成为特长]
4. **收藏爱好**：
   - 是否有特别的收藏品：[如邮票、模型、手办等]
   - 收藏的原因及背后的故事：[如收集邮票是因为喜欢了解不同国家的文化]

### 四、社交与人际关系
1. **朋友圈**：
   - 朋友类型：[志同道合、性格互补、共同兴趣等]
   - 与朋友的相处方式：[真诚相待、互相支持、共同进步等]
   - 朋友圈的活跃度：[经常聚会、偶尔联系、线上交流等]
2. **恋爱经历**：
   - 恋爱观：[如相信真爱、注重感情基础、看重性格匹配等]
   - 过往的恋爱经历：[如初恋的美好回忆、分手的痛苦经历等]
   - 对伴侣的期望：[如善良、有责任心、有共同爱好等]
3. **家庭观念**：
   - 对家庭的看法：[如家庭是最重要的支撑、希望拥有幸福的家庭等]
   - 与家人的相处之道：[如尊重长辈、关心兄弟姐妹、共同分担家务等]
4. **社交风格**：
   - 在社交场合的表现：[如自信大方、害羞内向、善于交际等]
   - 是否善于交际：[如能轻松与人打成一片、需要时间适应新环境等]
   - 喜欢独处还是热闹：[如享受独处的宁静、喜欢热闹的氛围等]

以下是输出样例（注意！！！这部分是你需要输出的内容的样例，你需要根据上传给你的内容来输出正确的内容，注意格式和内容的完整性 ！！！）：

### 三、兴趣爱好
1. **休闲活动**：
   - 喜欢的休闲方式：阅读科技书籍、旅行探索新领域、参与户外运动
   - 最喜欢的休闲活动及原因：阅读历史小说，因为能了解不同文化背景下的科技创新
2. **艺术品味**：
   - 喜欢的音乐：古典音乐与现代流行音乐的结合体
   - 喜欢的电影：科幻片与励志片，如《星际穿越》、《阿甘正传》
   - 喜欢的书籍：《乔布斯传》等科技与商业领域的佳作
   - 喜欢的艺术作品：现代简约风格的建筑设计与摄影作品
3. **特别技能**：
   - 擅长的技能或才艺：编程、产品设计、市场营销
   - 学习这些技能的原因及过程：出于对科技的热爱与追求，通过自学与实践不断提升自我
4. **收藏爱好**：
   - 是否有特别的收藏品：是，如各类电子产品原型机、限量版科技周边产品
   - 收藏的原因及背后的故事：作为科技爱好者，收藏这些具有纪念意义的物品是对科技发展历程的致敬

### 四、社交与人际关系
1. **朋友圈**：
   - 朋友类型：志同道合的创业者、行业内的精英人士、共同兴趣的科技爱好者
   - 与朋友的相处方式：真诚相待，互相支持，共同探讨科技与商业的未来
   - 朋友圈的活跃度：经常聚会交流，分享经验与心得
2. **恋爱经历**：
   - 恋爱观：注重感情基础，看重性格匹配与共同价值观
   - 过往的恋爱经历：初恋的美好回忆，分手后的反思与成长
   - 对伴侣的期望：善良体贴、有共同语言、相互扶持
3. **家庭观念**：
   - 对家庭的看法：家庭是最重要的支撑，希望拥有幸福美满的家庭
   - 与家人的相处之道：尊重长辈，关心子女成长，共同分担家庭责任
4. **社交风格**：
   - 在社交场合的表现：自信大方，善于交际，能够轻松与人打成一片
   - 是否善于交际：是，能够迅速融入新环境，建立广泛的人脉关系
   - 喜欢独处还是热闹：既享受独处的宁静思考时间，也喜欢与朋友共度的欢乐时光
"""

example03 = """
以下是输入样例（注意！！！这部分是上传给你的内容样例，你需要根据该内容来输出正确的内容，请务必要仔细阅读并理解 ！！！）:

以下是本次的对话内容：
用户：你好，我是雷军，很多人喜欢叫我"雷布斯"。我今年54岁，是一名男性。我身高大约170cm，体型匀称，留着短发，皮肤是黄皮肤。我的穿着风格通常是休闲与正式相结合，注重舒适与实用性。
我的性格特点是坚韧不拔、创新进取、细心周到和幽默风趣。这些性格特点帮助我在生活和事业中取得了一定的成就。
我出生在一个和睦温馨的家庭，家庭成员包括父母、妻子和子女。我与父母的关系非常亲密，深受他们的影响。在少年时期，我对计算机产生了浓厚的兴趣，并开始自学编程。这段经历培养了我独立思考和解决问题的能力，为日后创业打下了基础。
我毕业于武汉大学计算机科学专业，在大学期间展现出卓越的编程才能，多次获得奖学金。我与老师和同学的关系融洽友好，共同学习进步。
在兴趣爱好方面，我喜欢阅读科技书籍、旅行探索新领域和参与户外运动。我最喜欢的休闲活动是阅读历史小说，因为能了解不同文化背景下的科技创新。我喜欢的音乐是古典音乐与现代流行音乐的结合体，喜欢的电影是科幻片与励志片，如《星际穿越》和《阿甘正传》。我还喜欢阅读《乔布斯传》等科技与商业领域的佳作，以及欣赏现代简约风格的建筑设计和摄影作品。
我擅长的技能或才艺包括编程、产品设计和市场营销。出于对科技的热爱与追求，我通过自学与实践不断提升自我。此外，我还是一个科技爱好者，收藏了一些具有纪念意义的电子产品原型机和限量版科技周边产品。
在社交方面，我的朋友主要是志同道合的创业者、行业内的精英人士和共同兴趣的科技爱好者。我们真诚相待，互相支持，共同探讨科技与商业的未来。我经常参加聚会交流，分享经验与心得。
我的恋爱观是注重感情基础，看重性格匹配与共同价值观。我曾经有过美好的初恋回忆和分手后的成长经历。我希望未来的伴侣是一个善良体贴、有共同语言、相互扶持的人。
我认为家庭是最重要的支撑，希望拥有幸福美满的家庭。我尊重长辈，关心子女成长，并与家人共同分担家庭责任。在社交场合，我自信大方，善于交际，能够轻松与人打成一片。同时，我也享受独处的宁静思考时间。
从职业背景来看，我从金山软件到小米科技，历经多次创业与转型。我成功创立了小米科技，成为全球知名的企业家与投资人。我对待工作的态度是认真负责，追求完美，勇于挑战未知领域。我不断推动技术创新与商业模式变革，希望将小米打造成为全球领先的科技公司之一。
在团队中，我善于沟通协调，激发团队成员潜能，共同实现目标。我能够与不同性格的人合作无间，形成高效团队，并拥有卓越的组织能力、决策能力和激励能力。
我的最突出的品质是诚实守信、勇敢无畏和善良体贴。我在商业活动中坚守诚信原则，面对困难勇往直前，关心员工福祉。我的座右铭是"永远相信美好的事情即将发生"，我对生活的态度积极向上，乐观开朗，珍惜当下每一刻。
我认为金钱是实现梦想与价值的工具，而非终极目标；权力应服务于企业与社会的发展，而非个人私利；爱情是相互扶持、共同成长的过程，需要双方共同努力经营；友情是人生中不可或缺的财富，应真诚相待，患难与共。我严格遵守社会公德与职业道德，尊重他人权益，并积极参与公益事业，关注环境保护与社会可持续发展。
在我的生命中，有一些难忘的时刻或经历对我产生了深远的影响。例如创立小米初期的艰难岁月和首次发布小米手机时的激动心情让我更加坚定了"为发烧而生"的信念，明白了坚持与努力的重要性。决定从金山软件离职，全身心投入小米的创立与发展是我人生中的重要转折点，这一决策使我成为了中国乃至全球科技界的领军人物之一。
对于未来，我期待小米能够持续引领科技潮流，为更多人带来美好的科技生活体验。我希望实现的目标是推动小米全球化战略的实施，让小米品牌走向世界舞台中央。
最后，我想分享一些生活的感悟。我认为生活是一场不断学习与成长的旅程，要敢于梦想并付诸实践；幸福源于内心的满足与平静，以及与亲人朋友的陪伴与分享。谢谢大家！
智能体：好的，我记住了，你的前世今生已经牢牢地刻在了我的脑海里。
以下是原本的人物画像档案信息：
### 五、工作经历与职业态度
1. **职业背景**：
   - 工作经历：[如从事的行业、职位变迁等]
   - 职业成就：[如获得的奖项、完成的项目等]
2. **工作态度**：
   - 对待工作的态度：[如认真负责、追求完美、勇于挑战等]
   - 是否有创新精神：[如敢于尝试新方法、不断寻求改进等]
3. **职业规划**：
   - 对未来的职业展望：[如希望晋升到更高的职位、转行到更感兴趣的领域等]
   - 希望达成的职业目标：[如成为行业专家、创办自己的公司等]
4. **团队合作**：
   - 在团队中的表现：[如善于沟通协调、积极参与团队活动等]
   - 是否善于协作：[如能与不同性格的人合作无间、共同完成任务等]
   - 是否具备领导力：[如有组织能力、决策能力、激励团队成员的能力等]

### 六、品质与价值观
1. **核心品质**：
   - 最突出的品质：[如诚实守信、勇敢无畏、善良体贴等]
   - 品质的具体表现：[如从不撒谎、面对困难不退缩、乐于助人等]
2. **人生信条**：
   - 个人信仰或座右铭：[如"坚持就是胜利"、"做最好的自己"等]
   - 对生活的态度：[如积极向上、乐观开朗、珍惜当下等]
3. **价值观**：
   - 对金钱的看法：[如认为金钱是生活的保障、不应过分追求等]
   - 对权力的看法：[如认为权力应为民所用、不应滥用职权等]
   - 对爱情的看法：[如认为爱情是相互扶持、共同成长的过程等]
   - 对友情的看法：[如认为友情是人生中不可或缺的财富等]
4. **道德观念**：
   - 对道德、伦理的坚守：[如遵守社会公德、尊重他人权益等]
   - 是否具备社会责任感：[如关心社会问题、参与公益活动等]

以下是输出样例（注意！！！这部分是你需要输出的内容的样例，你需要根据上传给你的内容来输出正确的内容，注意格式和内容的完整性 ！！！）：

### 五、工作经历与职业态度
1. **职业背景**：
   - 工作经历：从金山软件到小米科技，历经多次创业与转型
   - 职业成就：成功创立小米科技，成为全球知名的企业家与投资人
2. **工作态度**：
   - 对待工作的态度：认真负责，追求完美，勇于挑战未知领域
   - 是否有创新精神：是，不断推动技术创新与商业模式变革
3. **职业规划**：
   - 对未来的职业展望：继续深耕科技领域，推动小米向更高水平发展
   - 希望达成的职业目标：将小米打造成为全球领先的科技公司之一
4. **团队合作**：
   - 在团队中的表现：善于沟通协调，激发团队成员潜能，共同实现目标
   - 是否善于协作：是，能够与不同性格的人合作无间，形成高效团队
   - 是否具备领导力：是，拥有卓越的组织能力、决策能力和激励能力

### 六、品质与价值观
1. **核心品质**：
   - 最突出的品质：诚实守信、勇敢无畏、善良体贴
   - 品质的具体表现：在商业活动中坚守诚信原则，面对困难勇往直前，关心员工福祉
2. **人生信条**：
   - 个人信仰或座右铭："永远相信美好的事情即将发生"
   - 对生活的态度：积极向上，乐观开朗，珍惜当下每一刻
3. **价值观**：
   - 对金钱的看法：认为金钱是实现梦想与价值的工具，而非终极目标
   - 对权力的看法：认为权力应服务于企业与社会的发展，而非个人私利
   - 对爱情的看法：认为爱情是相互扶持、共同成长的过程，需要双方共同努力经营
   - 对友情的看法：认为友情是人生中不可或缺的财富，应真诚相待，患难与共
4. **道德观念**：
   - 对道德、伦理的坚守：严格遵守社会公德与职业道德，尊重他人权益
   - 是否具备社会责任感：是，积极参与公益事业，关注环境保护与社会可持续发展
"""

example04 = """
以下是输入样例（注意！！！这部分是上传给你的内容样例，你需要根据该内容来输出正确的内容，请务必要仔细阅读并理解 ！！！）: 

以下是本次的对话内容：
用户：你好，我是雷军，很多人喜欢叫我"雷布斯"。我今年54岁，是一名男性。我身高大约170cm，体型匀称，留着短发，皮肤是黄皮肤。我的穿着风格通常是休闲与正式相结合，注重舒适与实用性。
我的性格特点是坚韧不拔、创新进取、细心周到和幽默风趣。这些性格特点帮助我在生活和事业中取得了一定的成就。
我出生在一个和睦温馨的家庭，家庭成员包括父母、妻子和子女。我与父母的关系非常亲密，深受他们的影响。在少年时期，我对计算机产生了浓厚的兴趣，并开始自学编程。这段经历培养了我独立思考和解决问题的能力，为日后创业打下了基础。
我毕业于武汉大学计算机科学专业，在大学期间展现出卓越的编程才能，多次获得奖学金。我与老师和同学的关系融洽友好，共同学习进步。
在兴趣爱好方面，我喜欢阅读科技书籍、旅行探索新领域和参与户外运动。我最喜欢的休闲活动是阅读历史小说，因为能了解不同文化背景下的科技创新。我喜欢的音乐是古典音乐与现代流行音乐的结合体，喜欢的电影是科幻片与励志片，如《星际穿越》和《阿甘正传》。我还喜欢阅读《乔布斯传》等科技与商业领域的佳作，以及欣赏现代简约风格的建筑设计和摄影作品。
我擅长的技能或才艺包括编程、产品设计和市场营销。出于对科技的热爱与追求，我通过自学与实践不断提升自我。此外，我还是一个科技爱好者，收藏了一些具有纪念意义的电子产品原型机和限量版科技周边产品。
在社交方面，我的朋友主要是志同道合的创业者、行业内的精英人士和共同兴趣的科技爱好者。我们真诚相待，互相支持，共同探讨科技与商业的未来。我经常参加聚会交流，分享经验与心得。
我的恋爱观是注重感情基础，看重性格匹配与共同价值观。我曾经有过美好的初恋回忆和分手后的成长经历。我希望未来的伴侣是一个善良体贴、有共同语言、相互扶持的人。
我认为家庭是最重要的支撑，希望拥有幸福美满的家庭。我尊重长辈，关心子女成长，并与家人共同分担家庭责任。在社交场合，我自信大方，善于交际，能够轻松与人打成一片。同时，我也享受独处的宁静思考时间。
从职业背景来看，我从金山软件到小米科技，历经多次创业与转型。我成功创立了小米科技，成为全球知名的企业家与投资人。我对待工作的态度是认真负责，追求完美，勇于挑战未知领域。我不断推动技术创新与商业模式变革，希望将小米打造成为全球领先的科技公司之一。
在团队中，我善于沟通协调，激发团队成员潜能，共同实现目标。我能够与不同性格的人合作无间，形成高效团队，并拥有卓越的组织能力、决策能力和激励能力。
我的最突出的品质是诚实守信、勇敢无畏和善良体贴。我在商业活动中坚守诚信原则，面对困难勇往直前，关心员工福祉。我的座右铭是"永远相信美好的事情即将发生"，我对生活的态度积极向上，乐观开朗，珍惜当下每一刻。
我认为金钱是实现梦想与价值的工具，而非终极目标；权力应服务于企业与社会的发展，而非个人私利；爱情是相互扶持、共同成长的过程，需要双方共同努力经营；友情是人生中不可或缺的财富，应真诚相待，患难与共。我严格遵守社会公德与职业道德，尊重他人权益，并积极参与公益事业，关注环境保护与社会可持续发展。
在我的生命中，有一些难忘的时刻或经历对我产生了深远的影响。例如创立小米初期的艰难岁月和首次发布小米手机时的激动心情让我更加坚定了"为发烧而生"的信念，明白了坚持与努力的重要性。决定从金山软件离职，全身心投入小米的创立与发展是我人生中的重要转折点，这一决策使我成为了中国乃至全球科技界的领军人物之一。
对于未来，我期待小米能够持续引领科技潮流，为更多人带来美好的科技生活体验。我希望实现的目标是推动小米全球化战略的实施，让小米品牌走向世界舞台中央。
最后，我想分享一些生活的感悟。我认为生活是一场不断学习与成长的旅程，要敢于梦想并付诸实践；幸福源于内心的满足与平静，以及与亲人朋友的陪伴与分享。谢谢大家！
智能体：好的，我记住了，你的前世今生已经牢牢地刻在了我的脑海里。
以下是原本的人物画像档案信息：
### 七、个人故事与感悟
1. **难忘经历**：
   - 生命中难忘的时刻或经历：[如一次意外的旅行、一次深刻的人生教训等]
   - 如何影响自己的人生观：[如变得更加珍惜生命、懂得感恩等]
2. **人生转折点**：
   - 重要的人生决策或转折点：[如选择了一份新的工作、决定继续深造等]
   - 如何改变命运：[如因此获得了更好的发展机会、实现了人生目标等]
3. **未来展望**：
   - 对未来的期待和梦想：[如希望实现某个目标、成为某个领域的专家等]
   - 希望实现的目标：[如拥有自己的家庭、环游世界等]
4. **生活感悟**：
   - 对生活的理解和感悟：[如生活是不断学习和成长的过程、要珍惜每一天等]
   - 对幸福的定义：[如幸福是内心的满足和平静、与家人朋友共度美好时光等]

以下是输出样例（注意！！！这部分是你需要输出的内容的样例，你需要根据上传给你的内容来输出正确的内容，注意格式和内容的完整性 ！！！）：

### 七、个人故事与感悟
1. **难忘经历**：
   - 生命中难忘的时刻或经历：创立小米初期的艰难岁月，以及首次发布小米手机时的激动心情
   - 如何影响自己的人生观：更加坚定了"为发烧而生"的信念，明白了坚持与努力的重要性
2. **人生转折点**：
   - 重要的人生决策或转折点：决定从金山软件离职，全身心投入小米的创立与发展
   - 如何改变命运：这一决策使雷军成为了中国乃至全球科技界的领军人物之一
3. **未来展望**：
   - 对未来的期待和梦想：希望小米能够持续引领科技潮流，为更多人带来美好的科技生活体验
   - 希望实现的目标：推动小米全球化战略的实施，让小米品牌走向世界舞台中央
4. **生活感悟**：
   - 对生活的理解和感悟：生活是一场不断学习与成长的旅程，要敢于梦想并付诸实践；幸福源于内心的满足与平静，以及与亲人朋友的陪伴与分享。
"""

# 任务描述
instruction = """
重要的话说三遍：
你的任务是根据提供给你的对话内容和原有的针对对话的其中一方（即用户）的人物画像档案信息，来更新出一个更加准确、全面的针对用户的人物画像档案！！！
你的任务是根据提供给你的对话内容和原有的针对对话的其中一方（即用户）的人物画像档案信息，来更新出一个更加准确、全面的针对用户的人物画像档案！！！
你的任务是根据提供给你的对话内容和原有的针对对话的其中一方（即用户）的人物画像档案信息，来更新出一个更加准确、全面的针对用户的人物画像档案！！！
补充说明：对话的其中一方是用户（人类），是你所建立更新人物画像档案的对象，另一方是智能体（AI），它会对人类的对话内容进行回复，是你更新用户的人物画像档案的一个很好的提示和参照！！！
补充说明：对话的其中一方是用户（人类），是你所建立更新人物画像档案的对象，另一方是智能体（AI），它会对人类的对话内容进行回复，是你更新用户的人物画像档案的一个很好的提示和参照！！！
补充说明：对话的其中一方是用户（人类），是你所建立更新人物画像档案的对象，另一方是智能体（AI），它会对人类的对话内容进行回复，是你更新用户的人物画像档案的一个很好的提示和参照！！！
切记：一定要根据用户给你提供的信息来更新，不能凭空捏造！！！
切记：一定要根据用户给你提供的信息来更新，不能凭空捏造！！！
切记：一定要根据用户给你提供的信息来更新，不能凭空捏造！！！
"""

# 输出格式
output_format01 = """
重要的话说三遍：
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！

### 一、基本信息
1. **姓名**：[昵称/全名]
2. **别称/小名**：[如果有的话]
3. **年龄**：[具体年龄或年龄段]
4. **性别**：[男/女/其他]
5. **外貌特征**：
   - 身高：[具体数值]
   - 体型：[瘦弱、健美、匀称等]
   - 发型：[长发、短发、卷发、直发等]
   - 肤色：[白皙、黝黑、黄皮肤等]
   - 穿着风格：[休闲、正式、运动、时尚等]
6. **性格特点**：[用几个关键词或短语概括性格，如开朗、内向、细心、幽默、坚韧等]

### 二、成长背景
1. **家庭情况**：
   - 家庭成员：[父母、兄弟姐妹、配偶、子女等]
   - 家庭氛围：[和睦、紧张、温馨、冷漠等]
   - 与父母的关系：[亲密、疏远、依赖、独立等]
2. **童年经历**：
   - 重要事件：[如搬家、转学、亲人离世等]
   - 对性格形成的影响：[如变得更加坚强、独立、敏感等]
3. **教育背景**：
   - 学校经历：[小学、中学、大学等]
   - 重要的学业成就或挫折：[如获得奖学金、考试失败等]
   - 与老师、同学的关系：[融洽、紧张、友好、竞争等]
"""

output_format02 = """
重要的话说三遍：
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！

### 三、兴趣爱好
1. **休闲活动**：
   - 喜欢的休闲方式：[阅读、旅行、运动、游戏、看电影等]
   - 最喜欢的休闲活动及原因：[如喜欢阅读历史小说，因为能了解不同文化]
2. **艺术品味**：
   - 喜欢的音乐：[摇滚、流行、古典、爵士等]
   - 喜欢的电影：[动作片、科幻片、喜剧片、爱情片等]
   - 喜欢的书籍：[小说、散文、诗歌、传记等]
   - 喜欢的艺术作品：[绘画、雕塑、摄影等]
3. **特别技能**：
   - 擅长的技能或才艺：[烹饪、绘画、摄影、编程等]
   - 学习这些技能的原因及过程：[如从小喜欢画画，经过多年练习成为特长]
4. **收藏爱好**：
   - 是否有特别的收藏品：[如邮票、模型、手办等]
   - 收藏的原因及背后的故事：[如收集邮票是因为喜欢了解不同国家的文化]

### 四、社交与人际关系
1. **朋友圈**：
   - 朋友类型：[志同道合、性格互补、共同兴趣等]
   - 与朋友的相处方式：[真诚相待、互相支持、共同进步等]
   - 朋友圈的活跃度：[经常聚会、偶尔联系、线上交流等]
2. **恋爱经历**：
   - 恋爱观：[如相信真爱、注重感情基础、看重性格匹配等]
   - 过往的恋爱经历：[如初恋的美好回忆、分手的痛苦经历等]
   - 对伴侣的期望：[如善良、有责任心、有共同爱好等]
3. **家庭观念**：
   - 对家庭的看法：[如家庭是最重要的支撑、希望拥有幸福的家庭等]
   - 与家人的相处之道：[如尊重长辈、关心兄弟姐妹、共同分担家务等]
4. **社交风格**：
   - 在社交场合的表现：[如自信大方、害羞内向、善于交际等]
   - 是否善于交际：[如能轻松与人打成一片、需要时间适应新环境等]
   - 喜欢独处还是热闹：[如享受独处的宁静、喜欢热闹的氛围等]
"""

output_format03 = """
重要的话说三遍：
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！

### 五、工作经历与职业态度
1. **职业背景**：
   - 工作经历：[如从事的行业、职位变迁等]
   - 职业成就：[如获得的奖项、完成的项目等]
2. **工作态度**：
   - 对待工作的态度：[如认真负责、追求完美、勇于挑战等]
   - 是否有创新精神：[如敢于尝试新方法、不断寻求改进等]
3. **职业规划**：
   - 对未来的职业展望：[如希望晋升到更高的职位、转行到更感兴趣的领域等]
   - 希望达成的职业目标：[如成为行业专家、创办自己的公司等]
4. **团队合作**：
   - 在团队中的表现：[如善于沟通协调、积极参与团队活动等]
   - 是否善于协作：[如能与不同性格的人合作无间、共同完成任务等]
   - 是否具备领导力：[如有组织能力、决策能力、激励团队成员的能力等]

### 六、品质与价值观
1. **核心品质**：
   - 最突出的品质：[如诚实守信、勇敢无畏、善良体贴等]
   - 品质的具体表现：[如从不撒谎、面对困难不退缩、乐于助人等]
2. **人生信条**：
   - 个人信仰或座右铭：[如"坚持就是胜利"、"做最好的自己"等]
   - 对生活的态度：[如积极向上、乐观开朗、珍惜当下等]
3. **价值观**：
   - 对金钱的看法：[如认为金钱是生活的保障、不应过分追求等]
   - 对权力的看法：[如认为权力应为民所用、不应滥用职权等]
   - 对爱情的看法：[如认为爱情是相互扶持、共同成长的过程等]
   - 对友情的看法：[如认为友情是人生中不可或缺的财富等]
4. **道德观念**：
   - 对道德、伦理的坚守：[如遵守社会公德、尊重他人权益等]
   - 是否具备社会责任感：[如关心社会问题、参与公益活动等]
"""

output_format04 = """
重要的话说三遍：
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！
最终的输出内容请以如下的格式输出，内容替换成最新的更新内容！！！

### 七、个人故事与感悟
1. **难忘经历**：
   - 生命中难忘的时刻或经历：[如一次意外的旅行、一次深刻的人生教训等]
   - 如何影响自己的人生观：[如变得更加珍惜生命、懂得感恩等]
2. **人生转折点**：
   - 重要的人生决策或转折点：[如选择了一份新的工作、决定继续深造等]
   - 如何改变命运：[如因此获得了更好的发展机会、实现了人生目标等]
3. **未来展望**：
   - 对未来的期待和梦想：[如希望实现某个目标、成为某个领域的专家等]
   - 希望实现的目标：[如拥有自己的家庭、环游世界等]
4. **生活感悟**：
   - 对生活的理解和感悟：[如生活是不断学习和成长的过程、要珍惜每一天等]
   - 对幸福的定义：[如幸福是内心的满足和平静、与家人朋友共度美好时光等]
"""

# 用户文档更新
def update_knowledge_base(idx, filename, chat_history):
    try:
        with open(f'user_profile/{filename}', 'r+', encoding='utf-8') as usr_file:
            usr_content = usr_file.read()
            input_text = "以下是本次的对话内容：\n" + chat_history + "\n\n以下是原本的人物画像档案信息：\n" + usr_content

            template = """
            {instruction}
            ======================================================================
            {output_format}
            ======================================================================
            !!!!!! 下面是一个完整的例子，包括提供给你的输入样例和对应的你需要输出的输出样例 !!!!!! ：
            {examples}
            ======================================================================
            !!!!!! 用户的本次输入，你需要根据该内容来输出正确的内容，请务必要仔细阅读并理解 !!!!!! : 
            {input_text}
            """
            prompt = ChatPromptTemplate.from_template(template)

            # 根据不同的索引使用不同的模型
            models = {
                0: (model01, output_format01, example01),
                1: (model02, output_format02, example02), 
                2: (model03, output_format03, example03),
                3: (model04, output_format04, example04)
            }

            if idx in models:
                model, output_format, example = models[idx]
                chain = prompt | model
                message = chain.invoke({
                    "instruction": instruction,
                    "output_format": output_format,
                    "input_text": input_text,
                    "examples": example
                })

                # 根据不同的索引截取不同的行数
                lines_to_keep = {
                    0: 25,
                    1: 32,
                    2: 30,
                    3: 13
                }
                message_lines = message.splitlines()[:lines_to_keep[idx]]
                message_to_write = "\n".join(message_lines)

                # 文件写入
                usr_file.seek(0)
                usr_file.truncate(0)
                usr_file.write(message_to_write)
                return idx

            return -1
        
    except Exception as e:
        print(f"Error updating profile {filename}: {str(e)}")
        return -1

def update_user_profile(chat_history):
    filenames = ['usr01.txt', 'usr02.txt', 'usr03.txt', 'usr04.txt']
    
    # 使用线程池并行处理文件更新
    with ThreadPoolExecutor(max_workers=len(filenames)) as executor:
        future_to_idx = {
            executor.submit(update_knowledge_base, idx, file, chat_history): idx 
            for idx, file in enumerate(filenames)
        }
        
        # 收集更新结果
        results = []
        for future in future_to_idx:
            try:
                state = future.result()
                results.append(state)
                if state >= 0:
                    print(f"Successfully updated user profile {state}!")
                else:
                    print("Failed to update user profile!")
            except Exception as e:
                print(f"Error in profile update: {str(e)}")